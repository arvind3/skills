# yaml-language-server: $schema=../skill-scenarios.schema.json
# Test scenarios for azure-ai-agents-ts skill evaluation
# Each scenario tests a specific usage pattern against acceptance criteria

config:
  model: gpt-4
  max_tokens: 2000
  temperature: 0.3

scenarios:
  # Basic Agent Creation
  - name: basic_agent_creation
    prompt: |
      Create a basic Azure AI agent in TypeScript that can respond to user messages.
      Include proper authentication, agent creation, thread management,
      message handling, and cleanup.
    expected_patterns:
      - "DefaultAzureCredential"
      - "AgentsClient"
      - "createAgent"
      - "threads.create"
      - "messages.create"
      - "deleteAgent"
    forbidden_patterns:
      - "openai.OpenAI"
      - "from azure.ai.agents"
    tags:
      - basic
      - authentication
    mock_response: |
      import { AgentsClient } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.PROJECT_ENDPOINT!;
      const modelDeploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const client = new AgentsClient(projectEndpoint, new DefaultAzureCredential());

      const agent = await client.createAgent(modelDeploymentName, {
        name: "my-agent",
        instructions: "You are a helpful assistant.",
      });

      const thread = await client.threads.create();

      await client.messages.create(thread.id, {
        role: "user",
        content: "Hello!",
      });

      const run = await client.runs.createAndProcess(thread.id, agent.id);

      if (run.status === "completed") {
        const messages = await client.messages.list(thread.id);
        for (const msg of messages.data) {
          if (msg.role === "assistant") {
            console.log(msg.content[0].text.value);
          }
        }
      }

      await client.deleteAgent(agent.id);

  # ToolSet with Code Interpreter and File Search
  - name: toolset_usage
    prompt: |
      Create an agent in TypeScript using ToolSet to add both code interpreter
      and file search tools with uploaded files.
    expected_patterns:
      - "ToolSet"
      - "addCodeInterpreterTool"
      - "addFileSearchTool"
      - "toolDefinitions"
      - "toolResources"
    forbidden_patterns:
      - "from azure.ai.agents"
    tags:
      - tools
      - toolset
    mock_response: |
      import { AgentsClient, ToolSet } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";
      import * as fs from "fs";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      // Upload file for code interpreter
      const fileStream1 = fs.createReadStream("./data/quarterly_results.csv");
      const codeInterpreterFile = await client.files.upload(fileStream1, "assistants", {
        fileName: "quarterly_results.csv",
      });

      // Upload file for file search
      const fileStream2 = fs.createReadStream("./data/documentation.txt");
      const fileSearchFile = await client.files.upload(fileStream2, "assistants", {
        fileName: "documentation.txt",
      });

      // Create vector store for file search
      const vectorStore = await client.vectorStores
        .createAndPoll({ fileIds: [fileSearchFile.id] })
        .pollUntilDone();

      // Create tool set
      const toolSet = new ToolSet();
      toolSet.addFileSearchTool([vectorStore.id]);
      toolSet.addCodeInterpreterTool([codeInterpreterFile.id]);

      // Create agent with tool set
      const agent = await client.createAgent("gpt-4o", {
        name: "analyst-agent",
        instructions: "You are a helpful agent that can analyze data and search documents.",
        tools: toolSet.toolDefinitions,
        toolResources: toolSet.toolResources,
      });

      console.log(`Created agent: ${agent.id}`);

  # File Search Tool with ToolUtility
  - name: file_search_tool_utility
    prompt: |
      Create an agent in TypeScript with file search capability using ToolUtility
      to search through uploaded documents.
    expected_patterns:
      - "ToolUtility"
      - "createFileSearchTool"
      - "vectorStores"
      - "files.upload"
    tags:
      - file-search
      - tools
    mock_response: |
      import { AgentsClient, ToolUtility } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";
      import * as fs from "fs";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      // Upload file
      const fileStream = fs.createReadStream("./docs/manual.pdf");
      const file = await client.files.upload(fileStream, "assistants", {
        fileName: "manual.pdf",
      });

      // Create vector store
      const vectorStore = await client.vectorStores.create({
        fileIds: [file.id],
        name: "my-vector-store",
      });

      // Create file search tool
      const fileSearchTool = ToolUtility.createFileSearchTool([vectorStore.id]);

      const agent = await client.createAgent("gpt-4o", {
        name: "file-search-agent",
        instructions: "Answer questions from the documentation.",
        tools: [fileSearchTool.definition],
        toolResources: fileSearchTool.resources,
      });

      console.log(`Created agent: ${agent.id}`);

  # Code Interpreter Tool
  - name: code_interpreter_tool
    prompt: |
      Create an agent in TypeScript with code interpreter capability that can
      execute code and analyze data files.
    expected_patterns:
      - "ToolUtility"
      - "createCodeInterpreterTool"
      - "files.upload"
    forbidden_patterns:
      - 'tools=["code_interpreter"]'
    tags:
      - code-interpreter
      - tools
    mock_response: |
      import { AgentsClient, ToolUtility } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";
      import * as fs from "fs";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      // Upload file
      const fileStream = fs.createReadStream("./data/sales.csv");
      const file = await client.files.upload(fileStream, "assistants", {
        fileName: "sales.csv",
      });

      // Create code interpreter tool
      const codeInterpreterTool = ToolUtility.createCodeInterpreterTool([file.id]);

      const agent = await client.createAgent("gpt-4o", {
        name: "data-analyst",
        instructions: "Analyze data and create visualizations.",
        tools: [codeInterpreterTool.definition],
        toolResources: codeInterpreterTool.resources,
      });

      console.log(`Created agent: ${agent.id}`);

  # Bing Grounding Tool
  - name: bing_grounding_tool
    prompt: |
      Create an agent in TypeScript with Bing grounding capability to search
      the web for information.
    expected_patterns:
      - "ToolUtility"
      - "createBingGroundingTool"
      - "connectionId"
    tags:
      - bing
      - grounding
      - tools
    mock_response: |
      import { AgentsClient, ToolUtility } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      const connectionId = process.env.AZURE_BING_CONNECTION_ID!;

      // Create Bing grounding tool
      const bingTool = ToolUtility.createBingGroundingTool([{ connectionId }]);

      const agent = await client.createAgent("gpt-4o", {
        name: "web-search-agent",
        instructions: "Search the web to answer questions with current information.",
        tools: [bingTool.definition],
      });

      console.log(`Created agent: ${agent.id}`);

  # Azure AI Search Tool
  - name: azure_ai_search_tool
    prompt: |
      Create an agent in TypeScript that uses Azure AI Search to query an
      existing search index.
    expected_patterns:
      - "ToolUtility"
      - "createAzureAISearchTool"
      - "index_name"
    tags:
      - azure-search
      - tools
    mock_response: |
      import { AgentsClient, ToolUtility } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      const connectionName = process.env.AZURE_AI_SEARCH_CONNECTION_NAME!;

      // Create Azure AI Search tool
      const searchTool = ToolUtility.createAzureAISearchTool(
        connectionName,
        "products-index",
        {
          queryType: "simple",
          topK: 3,
          indexConnectionId: connectionName,
          indexName: "products-index",
        },
      );

      const agent = await client.createAgent("gpt-4o", {
        name: "search-agent",
        instructions: "Help users find products using the search index.",
        tools: [searchTool.definition],
        toolResources: searchTool.resources,
      });

      console.log(`Created agent: ${agent.id}`);

  # Function Calling
  - name: function_tool_calling
    prompt: |
      Create an agent in TypeScript with custom function tools using ToolUtility.
      Show function definition and execution patterns.
    expected_patterns:
      - "ToolUtility"
      - "createFunctionTool"
      - "parameters"
      - "toolCallId"
    forbidden_patterns:
      - "tools=[get_weather]"
    tags:
      - function-calling
      - tools
    mock_response: |
      import {
        AgentsClient,
        ToolUtility,
        FunctionToolDefinition,
        RequiredToolCall,
        ToolOutput,
      } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      // Define function tool
      const weatherTool = ToolUtility.createFunctionTool({
        name: "getWeather",
        description: "Gets the weather for a location",
        parameters: {
          type: "object",
          properties: {
            location: { type: "string", description: "City and state" },
            unit: { type: "string", enum: ["celsius", "fahrenheit"] },
          },
          required: ["location"],
        },
      });

      // Function to execute tool calls
      function invokeTool(toolCall: RequiredToolCall & FunctionToolDefinition): ToolOutput {
        if (toolCall.function.name === "getWeather") {
          const args = JSON.parse(toolCall.function.parameters || "{}");
          return {
            toolCallId: toolCall.id,
            output: JSON.stringify({ weather: `72Â°F and sunny in ${args.location}` }),
          };
        }
        return {
          toolCallId: toolCall.id,
          output: JSON.stringify({ error: "Unknown function" }),
        };
      }

      const agent = await client.createAgent("gpt-4o", {
        name: "weather-agent",
        instructions: "Help users with weather information.",
        tools: [weatherTool.definition],
      });

      console.log(`Created agent: ${agent.id}`);

  # Connected Agent (Multi-Agent)
  - name: connected_agent_multi_agent
    prompt: |
      Create a multi-agent setup in TypeScript where a main agent can delegate
      to a connected specialist agent.
    expected_patterns:
      - "ToolUtility"
      - "createConnectedAgentTool"
      - "stockAgent"
    tags:
      - multi-agent
      - connected-agent
    mock_response: |
      import { AgentsClient, ToolUtility } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      const modelDeploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      // Create specialist agent
      const stockAgent = await client.createAgent(modelDeploymentName, {
        name: "stock-price-agent",
        instructions: "Get stock prices for companies. Return last known price if realtime unavailable.",
      });

      // Create connected agent tool
      const connectedAgentTool = ToolUtility.createConnectedAgentTool(
        stockAgent.id,
        "stock_price_bot",
        "Gets the stock price of a company",
      );

      // Create main agent with connected agent
      const mainAgent = await client.createAgent(modelDeploymentName, {
        name: "main-agent",
        instructions: "Help users with stock information using the connected agent.",
        tools: [connectedAgentTool.definition],
      });

      console.log(`Created main agent: ${mainAgent.id}`);

      // Cleanup
      await client.deleteAgent(mainAgent.id);
      await client.deleteAgent(stockAgent.id);

  # Streaming with Event Handler
  - name: streaming_event_handler
    prompt: |
      Create an agent in TypeScript that uses streaming responses with an
      event handler to process real-time message deltas.
    expected_patterns:
      - "AgentEventHandler"
      - "onMessageDelta"
      - "runs.stream"
      - "untilDone"
    forbidden_patterns:
      - "stream=True"
    tags:
      - streaming
      - advanced
    mock_response: |
      import { AgentsClient, AgentEventHandler } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";

      class MyEventHandler extends AgentEventHandler {
        onMessageDelta(delta: any): void {
          if (delta.text) {
            process.stdout.write(delta.text.value);
          }
        }

        onError(data: any): void {
          console.error("Error:", data);
        }
      }

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      const agent = await client.createAgent("gpt-4o", {
        name: "streaming-agent",
        instructions: "You are a helpful assistant.",
      });

      const thread = await client.threads.create();

      await client.messages.create(thread.id, {
        role: "user",
        content: "Tell me a story about Azure.",
      });

      const stream = await client.runs.stream(thread.id, agent.id, {
        eventHandler: new MyEventHandler(),
      });

      await stream.untilDone();

      await client.deleteAgent(agent.id);

  # Manual Run Polling
  - name: manual_run_polling
    prompt: |
      Create an agent in TypeScript that uses manual run polling instead of
      createAndProcess, showing how to handle run status transitions.
    expected_patterns:
      - "runs.create"
      - "runs.get"
      - 'status === "completed"'
      - "while"
    forbidden_patterns:
      - "createAndProcess"
    tags:
      - advanced
      - polling
    mock_response: |
      import { AgentsClient } from "@azure/ai-agents";
      import { DefaultAzureCredential } from "@azure/identity";

      const client = new AgentsClient(
        process.env.PROJECT_ENDPOINT!,
        new DefaultAzureCredential(),
      );

      const agent = await client.createAgent("gpt-4o", {
        name: "polling-agent",
        instructions: "You are a helpful assistant.",
      });

      const thread = await client.threads.create();

      await client.messages.create(thread.id, {
        role: "user",
        content: "Hello!",
      });

      // Create run without auto-processing
      let run = await client.runs.create(thread.id, agent.id);

      // Manual polling
      while (run.status === "queued" || run.status === "in_progress") {
        await new Promise((resolve) => setTimeout(resolve, 1000));
        run = await client.runs.get(thread.id, run.id);
      }

      if (run.status === "completed") {
        const messages = await client.messages.list(thread.id);
        for (const msg of messages.data) {
          if (msg.role === "assistant") {
            console.log(msg.content[0].text.value);
          }
        }
      } else if (run.status === "failed") {
        console.error(`Run failed: ${run.lastError?.message}`);
      }

      await client.deleteAgent(agent.id);
